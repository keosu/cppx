name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Code formatting check on Linux (lightweight, no build required)
  code-format:
    name: Code Format Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check code formatting
      uses: DoozyX/clang-format-lint-action@v0.18
      with:
        source: 'src tests examples'
        extensions: 'cpp,cppm,h'
        clangFormatVersion: 18
        style: file  # 使用 .clang-format 配置

  # Linux and macOS builds are currently disabled (MSVC-only project with /Zc:preprocessor)
  # Uncomment when cross-platform support is added
  
  # build-linux:
  #   name: Linux - ${{ matrix.compiler }} - ${{ matrix.mode }}
  #   runs-on: ubuntu-latest
  #   ... (omitted)

  build-windows:
    name: Windows - MSVC - ${{ matrix.mode }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        mode: [debug, release]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest
    
    - name: Configure
      run: |
        # Verify xmake is available
        xmake --version
        
        # Clean and configure
        xmake f -c
        xmake f -m ${{ matrix.mode }} -y -v
        
        # Show configuration
        xmake show
    
    - name: Build
      run: |
        # Build with limited parallelism for C++20 modules
        xmake -r -j 1 -v
    
    - name: Run tests
      run: xmake test -v
    
    - name: Build examples
      run: xmake build -g examples -j 1 -v

  # macOS build is currently disabled (MSVC-only project)
  # Uncomment when cross-platform support is added
  
  # build-macos:
  #   name: macOS - Clang - ${{ matrix.mode }}
  #   runs-on: macos-latest
  #   ... (steps omitted)

  # Code quality checks are disabled for now
  # Re-enable when formatting is standardized
  
  # code-quality:
  #   name: Code Quality Checks
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Check formatting
  #     run: clang-format --version

