name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-linux:
    name: Linux - ${{ matrix.compiler }} - ${{ matrix.mode }}
    runs-on: ubuntu-20
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-17]
        mode: [debug, release]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        if [[ "${{ matrix.compiler }}" == "gcc-13" ]]; then
          sudo apt-get install -y g++-13
          echo "CC=gcc-13" >> $GITHUB_ENV
          echo "CXX=g++-13" >> $GITHUB_ENV
        elif [[ "${{ matrix.compiler }}" == "clang-17" ]]; then
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 17
          sudo apt-get install -y clang-17
          echo "CC=clang-17" >> $GITHUB_ENV
          echo "CXX=clang++-17" >> $GITHUB_ENV
        fi
    
    - name: Install xmake
      run: |
        wget https://github.com/xmake-io/xmake/releases/download/v2.8.9/xmake-v2.8.9.gz.run
        chmod +x xmake-v2.8.9.gz.run
        sudo ./xmake-v2.8.9.gz.run --noexec --prefix=/usr/local
    
    - name: Configure
      run: |
        xmake f -m ${{ matrix.mode }} -y
    
    - name: Build
      run: xmake -v
    
    - name: Run tests
      run: xmake test -v

  build-windows:
    name: Windows - MSVC - ${{ matrix.mode }}
    runs-on: windows-20
    strategy:
      fail-fast: false
      matrix:
        mode: [debug, release]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Install xmake
      run: |
        Invoke-WebRequest -Uri "https://github.com/xmake-io/xmake/releases/download/v2.8.9/xmake-v2.8.9.win64.exe" -OutFile "xmake-installer.exe"
        .\xmake-installer.exe /S
        echo "$env:ProgramFiles\xmake" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Configure
      run: |
        xmake f -m ${{ matrix.mode }} -y
    
    - name: Build
      run: xmake -v
    
    - name: Run tests
      run: xmake test -v

  build-macos:
    name: macOS - Clang - ${{ matrix.mode }}
    runs-on: macos-20
    strategy:
      fail-fast: false
      matrix:
        mode: [debug, release]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install xmake
      run: |
        brew install xmake
    
    - name: Configure
      run: |
        xmake f -m ${{ matrix.mode }} -y
    
    - name: Build
      run: xmake -v
    
    - name: Run tests
      run: xmake test -v

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-20
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-17
    
    - name: Check formatting
      run: |
        find src tests examples -name '*.cpp' -o -name '*.cppm' -o -name '*.h' | xargs clang-format-17 --dry-run --Werror

